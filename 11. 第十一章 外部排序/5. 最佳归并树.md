
#### 最佳归并树

这一节要讨论的问题是，由 置换-选择 生成所得的初始归并段，其各段长度不等对平衡归并有何影响？

##### 各段长度不等 对 平衡归并 的影响

假设由置换一选择得到 9 个初始归并段，其长度（即记录数）依次为：9,30,12,18,3,17,2,6,24。现作 3-路平衡归，其归并树（表示归并过程的图）如图 1.8 所示，图中每个圆圈表示一个初始归并段，圆圈中数字表示归并段的长度。假设每个记录占一个物理 块,则两趙归并所需对外存进行的读/写次数为:

$\qquad (9+30+12+18+3+17+2+6+24) \times 2 \times 2 = 484$

![](https://gitee.com/mayundaze/img_bed/raw/master/20200805165852.png)

若将初始归并段的长度看成是归并树中叶子结点的权，则此三叉树的带权路径长度的两倍恰为 484。显然，归并方案不同，所得归并树亦不同，树的带权路径长度（或外存读/写次数）亦不同。回顾在第 6 章中曾讨论了有 $n$ 个叶子结点的带权路径长度最短的二叉树称赫夫曼树，同理，存在有 $n$ 个叶子结点的带权路径长度最短的 3 叉、4 叉、...、k 叉树，亦称为赫夫曼树。因此，若对长度不等的 $m$ 个初始归并段，构造一棵赫夫曼树作为归并树, 便可使在进行外部归并时所需对外存进行的读/写次数达最少。

例如，对上述 9 个初始归并段可构造一棵如图 11.9 所示的归并树，按此树进行归并，仅需对外存进行 446 次读/ 写，这棵归并树便称做 **最佳归并树**。

![](https://gitee.com/mayundaze/img_bed/raw/master/20200805170002.png)

图 11.9 的赫夫曼树是一棵真正的 3 叉树，即树中只有度为 3 或 0 的结点。假若只有 8 个初始归并段，例如，在前面例子中少了一个长度为 30 的归并段。如果在设计归并方案时，缺额的归并段留在最后，即除了最后一次作 2-路归并外，其他各次归并仍都是 3-路 归并,容易看出此归并方案的外存读/写次数为 386。显然，这不是最佳方案。正确的做法是，当初始归并段的数目不足时，需附加长度为零的“虚段”，按照赫夫曼树构成的原则，权为零的叶子应离树根最远，因此，这个只有 8 个初始归并段的归并树应如图 1.10 所示。

![](https://gitee.com/mayundaze/img_bed/raw/master/20200805170118.png)

##### 附加虚段数目的判定

那么，如何判定附加虚段的数目？当 3 叉树中只有度为 3 和 0 的结点时, 必有 $n_3 = (n_0 - 1)/2$ , 其中, $n_3$ 是度为 3 的结点数, $n_0$ 是度为零的结点数。由于 $n_3$ 必为整数，则 $(n_0 - 1) MOD 2 = 0$。这就是说，对 3-路归并而言，只有当初始归并段的个数为偶数时，才需加 1 个虚段。

在一般情况下，对 k- 路归并而言，容易推算得到，若 $(m - 1) MOD (k - 1) = 0$, 则不需要加虚段，否则需附加 $k - (m - 1) MOD (k - 1) - 1$ 个虚段。换句话说，第一次归并为 $(m - 1) MOD (k - 1) + 1$ 路归并。

若按最佳归并树的归并方案进行磁盘归并排序，需在内存建立一张载有归并段的长度和它在磁盘上的物理位置的索引表。
