
#### 第三种情况

第三种情况，系统在运行期间分配给用户的内存块的大小不固定，可以随请求而变。因此，可利用空间表中的结点即空闲块的大小也是随意的。通常，操作系统中的可利用空间表属这种类型。

系统刚开始工作时，整个内存空间是一个空闲块，即可利用空间表中只有一个大小为整个内存区的结点，随着分配和回收的进行，可利用空间表中的结点大小和个数也随之而变，上述图 $8.2(c)$ 中的链表即为这种情况的可利用空间表。

![](https://gitee.com/mayundaze/img_bed/raw/master/20200706171050.png)

由于链表中结点大小不同，则结点的结构与前两种情况也有所不同，结点中除标志域和链域之外，尚需有一个 `结点大小域（size）`，以指示空闲块的存储量，如图 8.4 所示。结点中的 space 域是一个地址连续的内存空间。

![](https://gitee.com/mayundaze/img_bed/raw/master/20200706171211.png)

由于可利用空间表中的结点大小不同，则在分配时就有一个如何分配的问题。

##### 1. 可利用空间表中的结点的分配

###### 可利用空间表中仅有一块指定大小的空闲块

假设某用户需大小为 n 的内存，而可利用空间表中 仅有一块大小为 $m \geq n$ 的空闲块，则只需将其中大小为 n 的一部分分配给申请分配的用户，同时将剩余大小为 $m - n$ 的部分作为一个结点留在链表中即可。

###### 可利用空间表中有若干个不小于 n 的空闲块

然而，若可利用空间表中有若干个不小于 n 的空闲块时，该分配哪一块呢？通常，可有 3 种不同的分配策略：

$(1)$ 首次拟合法。从表头指针开始査找可利用空间表，将找到的第一个大小不小于 n 的空闲块的一部分分配给用户。可利用空间表本身既不按结点的初始地址有序，也不按结点的大小有序。则在回收时，只要将释放的空闲块插入在链表的表头即可。

> 例如，在图 $8.2(c)$ 的状态时有用户 $U_9$ 进入系统并申请 7KB 的内存，系统在可利用空间表中进行査询，发现第一个空闲块即满足要求，则将此块中大小为 7KB 的一部分分配之，剩余 8KB 的空闲块仍在链表中，如图 8.5 (a）所示。图 8.5 (d）为分配给用户的占用块。

$(2)$ 最佳拟合法。将可利用空间表中一个不小于 n 且最接近 n 的空闲块的一部分分配给用户。则系统在分配前首先要对可利用空间表从头到尾扫视一遍，然后从中找出块不小于 n 且最接近 n 的空闲块进行分配。显然，在图 $8.2(c)$ 的状态时，系统就应该将第二个空闲块的一部分分配给用户 $U_9$，分配后的可利用空间表如图 $8.5(b)$ 所示。

在用最佳拟合法进行分配时，为了避免每次分配都要扫视整个链表。通常，预先设定可利用空间表的结构按空间块的大小自小至大有序，由此，只需找到第一块大于 n 的空闲块即进行分配，但在回收时，必须将释放的空闲块插入到合适的位置上去。

$(3)$ 最差拟合法。将可利用空间表中不小于 n 且是链表中最大的空闲块的一部分分配给用户。例如在图 8.2 (c）的状态时，就应将大小为 41KB 的空闲块中的一部分分配给用户，分配后的可利用空间表如图 8.5 (c）所示。显然，为了节省时间，此时的可利用空间表的结构应按空闲块的大小自大至小有序。这样，每次分配无需查找，只需从链表中删除第一个结点，并将其中一部分分配给用户，而剩余部分作为一个新的结点插入到可利用空间表的适当位置上去。当然，在回收时亦需将释放的空闲块插入到链表的适当位置上去。

![](https://gitee.com/mayundaze/img_bed/raw/master/20200706171632.png)

* 三种分配策略的比较

上述 3 种分配策略各有所长。

###### 空间上比较

一般来说，**最佳拟合法适用于请求分配的内存大小范围较广的系统**。因为按最佳拟合的原则进行分配时，总是找大小最接近请求的空闲块，由此系统中可能产生一些存储量甚小而无法利用的小片内存，同时也保留那些很大的内存块以备响应后面将发生的内存量特大的请求，从而使整个链表趋向于结点大小差别甚远的状态。

反之，由于 **最差拟合** 每次都从内存量最大的结点中进行分配，从而使链表中的结点大小趋于均匀，因此它 **适用于请求分配的内存大小范固较窄的系统**。

而 **首次拟合法**的分配是随机的，因此它介于两者之间，通常 **适用于系统事先不掌握运行期间可能出现的请求分配和释放的信息的情况**。

###### 时间上比较

从时间上来比较，首次拟合在分配时需查询可利用空间表，而回收时仅需插入在表头即可；

最差拟合恰相反，分配时无需查询链表，而回收时为将新的“空闲块”插入在链表中适当的位置上，需先进行查找；

最佳拟合无论分配和回收，均需査找链表，因此最费时间。

##### 2. 总结

因此，不同的情景需采用不同的方法，通常在选择时需考虑下列因素：

1. 用户的逻辑要求；
2. 请求分配量的大小分布；
3. 分配和释放的频率以及效率对系统的重要性等等。

###### 结点合并问题

在实际使用的系统中回收空闲块时还需考虑一个“结点合并”的问题。这是因为系统在不断进行分配和回收的过程中，大的空闲块逐渐被分割成小的占用块，在它们重又成为空闲块回收之后，即使是地址相邻的两个空闲块也只是作为两个结点插入到可利用空间表中，以致使得后来出现的大容量的请求分配无法进行，为了更有效地利用内存，就要求系统在回收时应考虑将地址相邻的空闲块合并成尽可能大的结点。

换句话说，在回收空闲块时，首先应检査地址与它相邻的内存是否是空闲块。具体实现的方法将在下面两节中讨论的动态存储管理系统中加以详细说明。
