
#### ISAM 文件和 VSAM 文件

##### ISAM 文件

索引顺序存取方法 ISAM 为 Indexed Sequential Access Methed 的缩写，它是一种专为磁盘存取设计的文件组织方式。由于磁盘是以盘组、柱面和磁道三级地址存取的设备，则可对磁盘上的数据文件建立盘组、柱面和磁道三级索引。文件的记录在同一盘组上存放时，应先集中放在一个柱面上，然后再顺序存放在相邻的柱面上，对同一柱面，则应按盘面的次序顺序存放。

> 这里的磁道索引，实际为盘面索引，为遵循习惯仍称磁道索引。

例如图 12.8 为存放在一个磁盘组上的 ISAM 文件，每个柱面建立个磁道索引，每个磁道索引项由两部分组成：基本索引项和溢出索引项。

![](https://gitee.com/mayundaze/img_bed/raw/master/20200806101456.png)

如图 12.9 所示，每一部分都包括关键字和指针两项，前者表示该磁道中最末一个记录的关键字（在此为最大关键字），后者指示该磁道中第一个记录的位置，柱面索引的每一个索引项也由关键字和指针两部分组成，前者表示该柱面中最末一个记录的关键字（最大关键字），后者指示该柱面上的磁道索引位置。

![](https://gitee.com/mayundaze/img_bed/raw/master/20200806101535.png)

柱面索引存放在某个柱面上，若柱面索引较大，占多个磁道时，则可建立柱面索引的索引一主索引。

在 ISAM 文件上检索记录时，先从主索引出发找到相应的柱面索引，再从柱面索引找到记录所在柱面的磁道索引，最后从磁道索引找到记录所在磁道的第一个记录的位置，由此出发在该磁道上进行顺序査找直至找到为止；反之，若找遍该磁道而不存在此记录，则表明该文件中无此记录。例如，査找关键字为 21 的记录时的查找路径如图 12.8 中的粗实线所示。

从图 12.8 中读者可看到，每个柱面上还开辟有一个溢出区；并且，磁道索引项中有溢出索引项，这是为插人记录所设置的。由于 ISAM 文件中记录是按关键字顺序存放的，则在插入记录时需移动记录，并将同一磁道上最末一个记录移至溢出区，同时修改磁道索引项。通常溢出区可有 3 种设置方法：

$(1)$ 集中存放一一整个文件设一个大的单一的溢出区；
$(2)$ 分散存放一一每个柱面设一个溢出区；
$(3)$ 集中与分散相结合一一溢出时记录先移至每个柱面各自的溢出区，待满之后再使用公共溢出区。图 12.8 是第二种设置法。

每个柱面的基本区是顺序存储结构，而溢出区是链表结构。同一磁道溢出的记录由指针相链，该磁道索引的溢出索引项中的关键字指示该磁道溢出的记录的最大关键字；而指针则指示在溢出区中的第一个记录。

图 12.10 所示为插人记录和溢出处理的具体例子。其中:

$(a)$ 为插入前的某一柱面上的状态; 
$(b)$ 为插入 $R_{65}$ 时，将第二道中关键字大于 65 的记录顺次后移，且使 $R_{90}$ 溢出至溢出区的情况；
$(c)$ 为插人 $R_{65}$ 之后的状态，此时 2 道的基本索引项的关键字改为 80, 且溢出索引项的关键字改为 90, 其指针指向第 4 道第一个记录即 $R_{90}$; 
$(d)$ 是相继插入 $R_{95}$ 和 $R_{83}$ 后的状态，$R_{95}$ 插入在第 3 道的第一个记录的位置而使 $R_{145}$ 溢出。而由于 80 < 83 < 90, 则 $R_{83}$ 被直接插入到溢出区，作为第 2 道在溢出区的第个记录，并将它的指针指向 $R_{90}$ 的位置，同时修改第 2 道索引的溢出索引项的指针指向 $R_{83}$。

![](https://gitee.com/mayundaze/img_bed/raw/master/20200806102143.png)

![](https://gitee.com/mayundaze/img_bed/raw/master/20200806102158.png)

ISAM 文件中删除记录的操作要比插入简单得多，只需找到待删除的记录，在其存储位置上作删除标记即可，而不需要移动记录或改变指针，但在经过多次的增删后，文件的结构可能变得很不合理。此时，大量的记录进入溢出区，而基本区中又浪费很多空间。因此，通常需要周期地整理 ISAM 文件。把记录读入内存，重新排列，复制成一个新的 ISAM 文件，填满基本区而空出溢出区。

最后，我们简单讨论一下 ISAM 文件中柱面索引的位置。

通常，磁道索引放在每个柱面的第一道上，那么，柱面索引是否也放在文件的第一个柱面上呢？由于每一次检索都需先査找柱面索引，则磁头需在各柱面间来回移动，我们希望磁头移动距离的平均值最小。假设文件占有 $n$ 个柱面，柱面索引在第 $x$ 柱面上。则磁头移动距离的平均值为：

$\qquad\begin{aligned} \bar{s} &=\frac{1}{n}\left[\sum_{i=1}^{x}(x-i)+\sum_{i=x+1}^{n}(i-x)\right] \\\\ &=\frac{1}{n}\left[x^{2}-(n+1) x+\frac{n(n+1)}{2}\right] \end{aligned}$

令 $\begin{aligned}\frac{\mathrm{d} \bar{s}}{\mathrm{d} x} = 0 \end{aligned}$, 得到 $\begin{aligned} x = \frac{n + 1}{2} \end{aligned}$。这就是说，柱面索引应放在数据文件的中间位置的柱面上。
